<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<h1>普通用户</h1>
    <button id="btn2">点我登录</button>
    <button id="btn3">点我登出</button>
<input id="ip" type="text" value="http://127.0.0.1:8809">
<div>
    <button id="btn4">点我邮箱注册</button>
    <button id="btn5">点我手机注册</button>
    <div>
        <span>用户名：</span>
        <input type="text" id="username">
    </div>
    <div>
        <span>密码：</span>
        <input type="password" id="password">
    </div>
    <div>
        <span>邮箱：</span>
        <input type="email" id="email">
    </div>
    <div>
        <span>手机号：</span>
        <input type="phone" id="phone">
    </div>
    <div>
        <span>验证码：</span>
        <input type="text" id="code">
    </div>
</div>
</body>
<script src="../static/js/jquery-3.5.1.min.js"></script>
<script src="../static/js/zjax.js"></script>
<script>
    $(function () {
        $("#btn2").click(function (){
            $.ajax({
                url:"/hoppinzq?method=login",
                data:JSON.stringify({
                    "user":{
                        "username":"zhangqi",
                        "password":"19zhangqi"
                    }
                }),
                dataType:"json",
                type:"post",
                success:function (data) {
                    if(data.code==200){
                        //let zq_token=getCookie("ZQ_TOKEN");
                        alert("登陆成功，有效时长7天");
                        let query = window.location.search.substring(1);
                        console.log(query)
                        let reUrl=query.split("redirect=")[1];
                        if(reUrl.indexOf("ucode=")!=-1){
                            let gqCodeUrl=reUrl.split("ucode=")[1];
                            if(gqCodeUrl.indexOf("?")==-1){
                                gqCodeUrl=data.data.ucode;
                            }else{
                                gqCodeUrl=data.data.ucode+gqCodeUrl.split("&")[1]
                            }
                            reUrl=reUrl.split("ucode=")[0]+"?ucode="+gqCodeUrl;
                        }else{
                            if(reUrl.indexOf("?")==-1){
                                reUrl+="?ucode="+data.data.ucode;
                            }else{
                                reUrl+="&ucode="+data.data.ucode;
                            }
                        }

                        // if(reUrl.indexOf(window.location.host)==-1){
                        //     $("body").append($("<iframe style='display: none' src='"+ip+"/cookie.html?cookie='"+zq_token+"&redirect="+reUrl+"></iframe>"));
                        // }else{
                        //     window.location.href=reUrl;
                        // }

                        window.location.href=reUrl;
                    }else{
                        alert("登陆失败:"+JSON.stringify(data));
                    }
                }
            })
        })

        $("#btn3").click(function (){
            $.ajax({
                url:"/hoppinzq?method=logout&params=",
                success:function (data) {
                    alert("登出成功")
                }
            })
        })


        $("#btn4").click(function () {
            let user={};
            if($("#username").val()!=""){
                user.username=$("#username").val();
            }
            if($("#password").val()!=""){
                user.password=$("#password").val();
            }
            if($("#email").val()!=""){
                user.email=$("#email").val();
            }
            if($("#code").val()!=""){
                user.code=$("#code").val();
            }
            $.ajax({
                url:"/hoppinzq?method=registerEmail",
                data:JSON.stringify({
                    "user":user
                }),
                dataType:"json",
                type:"post",
                success:function (data) {
                    console.log(data)
                }
            })
        });

        $("#btn5").click(function () {
            let user={};
            if($("#username").val()!=""){
                user.username=$("#username").val();
            }
            if($("#password").val()!=""){
                user.password=$("#password").val();
            }
            if($("#phone").val()!=""){
                user.phone=$("#phone").val();
            }
            if($("#code").val()!=""){
                user.code=$("#code").val();
            }
            $.ajax({
                url:"/hoppinzq?method=registerBySms",
                data:JSON.stringify({
                    "user":user
                }),
                dataType:"json",
                type:"post",
                success:function (data) {
                    console.log(data)
                }
            })
        })
    })

    function removePort(url){
        return url.substring(0,url.lastIndexOf(":"));
    }

    function getCookie(cname){
        let name = cname + "=";
        let ca = document.cookie.split(';');
        for(let i=0; i<ca.length; i++)
        {
            let c = ca[i].trim();
            if (c.indexOf(name)==0) return c.substring(name.length,c.length);
        }
        return "";
    }

</script>
</html>