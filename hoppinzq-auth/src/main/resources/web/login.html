<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<!--    <button id="btn">请求博客类别</button>-->
<!--    <button id="btn1">新增博客</button>-->
    <button id="btn2">点我登录</button>
    <button id="btn3">点我登出</button>
    <input id="ip" type="text" value="http://1.15.232.156:8809">
</body>
<script src="../static/jquery-3.5.1.min.js"></script>
<script src="../static/zjax.js"></script>

<script>
    $(function () {
        let ip="http://1.15.232.156:8809";
        // $("#btn1").click(function () {
        //     $.ajax({
        //         url:"http://127.0.0.1:8809/hoppinzq?method=insertBlog",
        //         type:"post",
        //         isRedirect:true,
        //         data: JSON.stringify({}),
        //         dataType:"json",
        //         // xhrFields : {
        //         //     withCredentials: true
        //         // },
        //         //contentType: "application/json",
        //         success:function (data) {
        //             console.log(data);
        //         },
        //         complete:function (xhr,data) {
        //             let url = xhr.getResponseHeader("redirect");
        //             let enable = xhr.getResponseHeader("enableRedirect");
        //             if((enable == "true") && (url != "")){
        //                 let win = window;
        //                 while(win != win.top){
        //                     win = win.top;
        //                 }
        //                 win.location.href = url;
        //             }
        //         }
        //     })
        // })
        // $("#btn").click(function (){
        //     $.zjax({
        //         url:"http://127.0.0.1:8804/hoppinzq?method=test&params=",
        //         isRedirect: true,
        //         success:function (data){
        //
        //         },
        //         // complete:function (xhr,data) {
        //         //     let url = xhr.getResponseHeader("redirect");
        //         //     let enable = xhr.getResponseHeader("enableRedirect");
        //         //     if((enable == "true") && (url != "")){
        //         //         let win = window;
        //         //         while(win != win.top){
        //         //             win = win.top;
        //         //         }
        //         //         win.location.href = url;
        //         //     }
        //         // }
        //     })
        // })
        $("#btn2").click(function (){
            ip=$("#ip").val();
            $.ajax({
                url:"/hoppinzq?method=login",
                data:JSON.stringify({
                    "user":{
                        "username":"zhangqi",
                        "password":"19zhangqi"
                    }
                }),
                dataType:"json",
                type:"post",
                success:function (data) {
                    let zq_token=getCookie("ZQ_TOKEN");
                    alert("登陆成功，有效时长10min");
                    let query = window.location.search.substring(1);
                    let vars = query.split("&");
                    for (let i = 0; i < vars.length; i++) {
                        let pair = vars[i].split("=");
                        if (pair[0] == "redirect") {
                            if(removePort(pair[1]).indexOf(removePort(window.location.host))==-1){
                                $("body").append($("<iframe style='display: none' src='"+ip+"/cookie.html?cookie='"+zq_token+"&redirect="+pair[1]+"></iframe>"));
                            }else{
                                window.location.href=pair[1];
                            }
                        }
                    }
                }
            })
        })

        $("#btn3").click(function (){
            $.ajax({
                url:"/hoppinzq?method=logout&params=",
                success:function (data) {
                    alert("登出成功")
                }
            })
        })
    })

    function removePort(url){
        return url.substring(0,url.lastIndexOf(":"));
    }

    function getCookie(cname){
        let name = cname + "=";
        let ca = document.cookie.split(';');
        for(let i=0; i<ca.length; i++)
        {
            let c = ca[i].trim();
            if (c.indexOf(name)==0) return c.substring(name.length,c.length);
        }
        return "";
    }
</script>
</html>