<!DOCTYPE html>
<html lang="zxx">

<head>
    <title>Login</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/css/style.css" type="text/css" media="all"/>
    <link href="../static/css/font-awesome.css" rel="stylesheet">
</head>
<body>
<section class="w3l-form-36">
    <div class="form-36-mian section-gap">
        <div class="wrapper" style="display: flex;justify-content: center">
            <div class="form-inner-cont">
                <h3>登录</h3>
                <div class="signin-form">
                    <span style="margin-left: 192px;visibility: collapse" id="login_username_tips">不是你的邮箱</span>
                    <div class="form-input login_username">
                        <span class="fa fa-user-circle" aria-hidden="true"></span>
                        <input type="text" name="username" id="login_username" placeholder="用户名"/>
                    </div>
                    <div class="form-input login_password">
                        <span class="fa fa-key" aria-hidden="true"></span>
                        <input type="password" name="password" id="login_password" placeholder="密码"/>
                    </div>
                    <div class="form-input none login_mobile">
                        <span class="fa fa-mobile" aria-hidden="true"></span>
                        <input type="text" name="mobile" id="login_mobile" placeholder="手机号"/>
                    </div>
                    <div class="form-input none login_mobile_code">
                        <span class="fa fa-key" aria-hidden="true"></span>
                        <input type="text" name="login_mobile_code" id="login_mobile_code" placeholder="6位验证码"/>
                    </div>
                    <div class="login-remember d-grid">
                        <label class="check-remaind remember_username_login">
                            <input type="checkbox">
                            <span class="checkmark"></span>
                            <p class="remember">记住用户名</p>
                        </label>
                        <label class="check-remaind">
                            <p class="user_username_login none login-sd">用户名登录</p>
                            <p class="user_mobile_login login-sd">手机验证码登录</p>
                        </label>
                    </div>
                    <div>
                        <button class="btn theme-button login-btn none send_mobile_code_login_btn">发送验证码</button>
                        <button class="btn theme-button login-btn user_login_btn">登录</button>
                    </div>
                    <div class="new-signup">
                        <a class="signuplink">忘记密码？</a>
                    </div>
                </div>

                <div class="social-icons">
                    <p class="continue"><span>Or</span></p>
                    <div class="social-links social-links-dark">
                        <a class="social-link" href="#" title="qq">
                            <i class="fa fa-qq"></i>
                        </a>
                        <a class="social-link" href="#" title="weixin">
                            <i class="fa fa-wechat"></i>
                        </a>
                        <a class="social-link" href="#" title="weibo">
                            <i class="fa fa-weibo"></i>
                        </a>
                        <a class="social-link" href="#" title="gitee">
                            <i class="fa fa-github"></i>
                        </a>
                    </div>
<!--                    <div class="social-login threeLogin">-->
<!--&lt;!&ndash;                        <a class="nqq" href="https://wiki.connect.qq.com/%E4%BD%BF%E7%94%A8authorization_code%E8%8E%B7%E5%8F%96access_token"></a>&ndash;&gt;-->
<!--&lt;!&ndash;                        <a class="nwx" href="https://gitee.com/api/v5/oauth_doc#/"></a>&ndash;&gt;-->
<!--&lt;!&ndash;                        <a class="gitee" href="https://gitee.com/oauth/authorize?client_id=543d047606c0130cdd58d806e1b84f89e91abb253574cfdd1e6290fd90e15a28&redirect_uri=http://hoppinzq.com&response_type=code"></a>&ndash;&gt;-->
<!--                    </div>-->
                </div>
                <p class="signup">还没有账号? <a href="#signup.html" class="signuplink">注册</a></p>
            </div>

            <div class="form-inner-cont" style="display:none;">
            </div>

        </div>
    </div>
</section>
<div class="modal fade" id="loginModal" style="display:none;">
    <div class="modal-dialog modal-sm" style="width:327px;">
        <div class="modal-content" style="border:none;">
            <div class="col-left"></div>
            <div class="col-right">
                <div class="modal-header">
                    <button type="button" id="login_close" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="loginModalLabel" style="font-size: 18px;">我是人</h4>
                </div>
                <div class="modal-body">
                    <section class="box-login v5-input-txt" id="box-login">
                        <div id="imgVer" style="display:inline-block;"></div>
                    </section>
                </div>
            </div>
        </div>
    </div>

</div>
</body>
<script src="../static/js/jquery-3.5.1.min.js"></script>
<script src="../static/js/img_ver.js"></script>
<script src="../static/js/modal.js"></script>
<script src="https://cdn.bootcss.com/crypto-js/3.1.9-1/crypto-js.min.js"></script>

<script>
    $(function () {
        if(getCookie("ZQ_USER_NAME")!=""){
            $(".check-remaind").find("input").prop("checked","checked");
            $("#login_username").val(getCookie("ZQ_USER_NAME"))
        }

        $("#login_username").focus(function () {
            $("#login_username_tips").css("visibility", "visible");
        }).blur(function () {
            $("#login_username_tips").css("visibility", "collapse");
        })
        imgVer({
            el: '$("#imgVer")',
            width: '260',
            height: '116',
            img: [
                '/static/images/ver.png',
                '/static/images/ver-1.png',
                '/static/images/ver-2.png',
                '/static/images/ver-3.png'
            ],
            success: function () {
                //alert('执行登录函数');
                $.ajax({
                    url:"/hoppinzq?method=login",
                    data:JSON.stringify({
                        "user":{
                            "username":$("#login_username").val(),
                            "password":$("#login_password").val(),
                            "isRemember":$(".check-remaind").find("input").is(":checked")?1:0
                        }
                    }),
                    dataType:"json",
                    type:"post",
                    success:function (data) {
                        console.log(data)
                        if(data.code==200){
                            //let zq_token=getCookie("ZQ_TOKEN");
                            alert("登陆成功，有效时长7天");
                            let query = window.location.search.substring(1);
                            if(query=="")return;
                            let reUrl=query.split("redirect=")[1];
                            if(reUrl.indexOf("ucode=")!=-1){
                                let gqCodeUrl=reUrl.split("ucode=")[1];
                                if(gqCodeUrl.indexOf("?")==-1){
                                    gqCodeUrl=data.data.ucode;
                                }else{
                                    gqCodeUrl=data.data.ucode+gqCodeUrl.split("&")[1]
                                }
                                reUrl=reUrl.split("ucode=")[0]+"?ucode="+gqCodeUrl;
                            }else{
                                if(reUrl.indexOf("?")==-1){
                                    reUrl+="?ucode="+data.data.ucode;
                                }else{
                                    reUrl+="&ucode="+data.data.ucode;
                                }
                            }

                            // if(reUrl.indexOf(window.location.host)==-1){
                            //     $("body").append($("<iframe style='display: none' src='"+ip+"/cookie.html?cookie='"+zq_token+"&redirect="+reUrl+"></iframe>"));
                            // }else{
                            //     window.location.href=reUrl;
                            // }
                            window.location.href=reUrl;
                        }else{
                            alert("登陆失败:"+JSON.stringify(data));
                            $("#login_close").click();
                        }
                    }
                })
            },
            error: function () {
                //alert('错误什么都不执行')
            }
        });

        $(".login-btn").on("click", function () {
            if($("#login_username").val().length==0){
                alert("请填写用户名");
                $("#login_username").focus();
                return;
            }
            if($("#login_password").val().length==0){
                alert("请填写密码");
                $("#login_password").focus();
                return;
            }
            $("#loginModal").modal("show");
        }),function() {
            var e = [];
            $(".modal").on("show.bs.modal",
                function() {
                    for (var s = 0; e.length > s; s++) e[s] && (e[s].modal("hide"), e[s] = null);
                    e.push($(this));
                    var o = $(this),
                        a = o.find(".modal-dialog"),
                        t = $('<div style="display:table; width:100%; height:100%;"></div>');
                    t.html('<div style="vertical-align:middle; display:table-cell;"></div>'),
                        t.children("div").html(a),
                        o.html(t)
                })
        }();

        $(".user_mobile_login").click(function () {
            $(".login_username").slideUp(500);
            $(".login_password").slideUp(500);
            $(".user_login_btn").slideUp(500);
            $(".remember_username_login").css("visibility", "collapse");
            $(this).slideUp(500,function () {
                $(".user_username_login").slideDown(500);
                $(".login_mobile").slideDown(500).css("display","grid");
                $(".login_mobile_code").slideDown(500).css("display","grid");
                $(".send_mobile_code_login_btn").slideDown(500);
            })
        });
        $(".user_username_login").click(function () {
            $(".login_mobile").slideUp(500);
            $(".login_mobile_code").slideUp(500);
            $(".send_mobile_code_login_btn").slideUp(500);
            $(this).slideUp(500,function () {
                $(".remember_username_login").css("visibility", "visible");
                $(".user_mobile_login").slideDown(500)
                $(".login_username").slideDown(500);
                $(".login_password").slideDown(500);
                $(".user_login_btn").slideDown(500);
            })
        });
    })




    function getCookie(cname){
        let name = cname + "=";
        let ca = document.cookie.split(';');
        for(let i=0; i<ca.length; i++)
        {
            let c = ca[i].trim();
            if (c.indexOf(name)==0) return c.substring(name.length,c.length);
        }
        return "";
    }
    //DES加密
    function encryptByDES(message, key){
        var keyHex = CryptoJS.enc.Utf8.parse(key);
        var encrypted = CryptoJS.DES.encrypt(message, keyHex, {
            mode: CryptoJS.mode.ECB,
            padding: CryptoJS.pad.Pkcs7
        });
        return encrypted.ciphertext.toString();
    }
    //DES加密
    function decryptByDES(ciphertext, key){
        var keyHex = CryptoJS.enc.Utf8.parse(key);
        var decrypted = CryptoJS.DES.decrypt({
            ciphertext: CryptoJS.enc.Hex.parse(ciphertext)
        }, keyHex, {
            mode: CryptoJS.mode.ECB,
            padding: CryptoJS.pad.Pkcs7
        });
        var result_value = decrypted.toString(CryptoJS.enc.Utf8);
        return result_value;
    }

    //加密
    function encryptByAES(plaintext,key) {
        if (plaintext instanceof Object) {
            //JSON.stringify
            plaintext = JSON.stringify(plaintext)
        }
        let encrypted = CryptoJS.AES.encrypt(CryptoJS.enc.Utf8.parse(plaintext), CryptoJS.enc.Utf8.parse(key), {mode:CryptoJS.mode.ECB,padding: CryptoJS.pad.Pkcs7});
        return encrypted.toString();
    }

    //解密
    function decryptByAES(ciphertext,key) {
        let decrypt = CryptoJS.AES.decrypt(ciphertext, CryptoJS.enc.Utf8.parse(key), {mode:CryptoJS.mode.ECB,padding: CryptoJS.pad.Pkcs7});
        let decString = CryptoJS.enc.Utf8.stringify(decrypt).toString();
        if(decString.charAt(0) === "{" || decString.charAt(0) === "[" ){
            //JSON.parse
            decString = JSON.parse(decString);
        }
        return decString;
    }
</script>
</html>