<!DOCTYPE html>
<html lang="zxx">

<head>
    <title>Login</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/css/style.css" type="text/css" media="all"/>
    <link href="../static/css/font-awesome.css" rel="stylesheet">
</head>
<body style=" background-size: cover;background-image: linear-gradient(to right, rgba(0, 0, 0, 0.85), rgba(255, 255, 255, 0));background-attachment: fixed;">
<section class="w3l-form-36">
    <div class="form-36-mian section-gap">
        <div class="wrapper" style="display: flex;justify-content: center">
            <div class="form-inner-cont" id="login_page">
                <h3>登录</h3>
                <div class="signin-form">
                    <span style="margin-left: 192px;visibility: collapse" id="login_username_tips">不是你的邮箱</span>
                    <div class="form-input login_username">
                        <span class="fa fa-user-circle" aria-hidden="true"></span>
                        <input type="text" name="username" id="login_username" placeholder="用户名"/>
                    </div>
                    <div class="form-input login_password">
                        <span class="fa fa-key" aria-hidden="true"></span>
                        <input type="password" name="password" id="login_password" placeholder="密码"/>
                    </div>
                    <div class="form-input none login_mobile">
                        <span class="fa fa-mobile" aria-hidden="true"></span>
                        <input type="text" name="mobile" id="login_mobile" placeholder="手机号"/>
                    </div>
                    <div class="form-input none login_mobile_code">
                        <span class="fa fa-key" aria-hidden="true"></span>
                        <input type="text" name="login_mobile_code" id="login_mobile_code" placeholder="6位验证码"/>
                    </div>
                    <div class="login-remember d-grid">
                        <label class="check-remaind remember_username_login">
                            <input type="checkbox">
                            <span class="checkmark"></span>
                            <p class="remember">记住用户名</p>
                        </label>
                        <label class="check-remaind">
                            <p class="user_username_login none login-sd">用户名登录</p>
                            <p class="user_mobile_login login-sd">手机验证码登录</p>
                        </label>
                    </div>
                    <div>
                        <button class="btn theme-button login-btn none send_email_code_login_btn">发送验证码</button>
                        <button class="btn theme-button login-btn user_login_btn">登录</button>
                    </div>
                    <div class="new-signup">
                        <a class="signuplink">忘记密码？</a>
                    </div>
                </div>

                <div class="social-icons">
                    <p class="continue"><span>Or</span></p>
                    <div class="social-links social-links-dark">
                        <a class="social-link" href="#" title="qq">
                            <i class="fa fa-qq"></i>
                        </a>
                        <a class="social-link" href="#" title="weixin">
                            <i class="fa fa-wechat"></i>
                        </a>
                        <a class="social-link" href="#" title="weibo">
                            <i class="fa fa-weibo"></i>
                        </a>
                        <a class="social-link" target="_blank" href="https://gitee.com/oauth/authorize?client_id=543d047606c0130cdd58d806e1b84f89e91abb253574cfdd1e6290fd90e15a28&redirect_uri=http%3A%2F%2Fhoppinzq.com%2Foauth%3Ftype%3Dgitee&response_type=code" title="gitee">
                            <i class="fa fa-github"></i>
                        </a>
                    </div>
<!--                    <div class="social-login threeLogin">-->
<!--&lt;!&ndash;                        <a class="nqq" href="https://wiki.connect.qq.com/%E4%BD%BF%E7%94%A8authorization_code%E8%8E%B7%E5%8F%96access_token"></a>&ndash;&gt;-->
<!--&lt;!&ndash;                        <a class="nwx" href="https://gitee.com/api/v5/oauth_doc#/"></a>&ndash;&gt;-->
<!--&lt;!&ndash;                        <a class="gitee" href="https://gitee.com/oauth/authorize?client_id=543d047606c0130cdd58d806e1b84f89e91abb253574cfdd1e6290fd90e15a28&redirect_uri=http://hoppinzq.com&response_type=code"></a>&ndash;&gt;-->
<!--                    </div>-->
                </div>
                <p class="signup">还没有账号? <a class="signuplink" id="register">注册</a></p>
            </div>

            <div class="form-inner-cont" id="register_page" style="display:none;">
                <h3>注册</h3>
                <div class="signin-form">
                    <span style="margin-left: 192px;visibility: collapse"></span>
                    <div class="form-input register_username">
                        <span class="fa fa-user-circle" aria-hidden="true"></span>
                        <input type="text" name="register_username" id="register_username" placeholder="用户名"/>
                    </div>
                    <div class="form-input register_email">
                        <span class="fa fa-envelope-o" aria-hidden="true"></span>
                        <input type="email" name="register_email" id="register_email" placeholder="邮箱号"/>
                    </div>
                    <div class="form-input register_email_code">
                        <span class="fa fa-envelope-o" aria-hidden="true"></span>
                        <input type="email" name="register_email_code" id="register_email_code" placeholder="邮箱号"/>
                    </div>
                    <div class="form-input none register_mobile">
                        <span class="fa fa-mobile" aria-hidden="true"></span>
                        <input type="text" name="mobile" id="register_mobile" placeholder="手机号"/>
                    </div>
                    <div class="form-input register_password">
                        <span class="fa fa-key" aria-hidden="true"></span>
                        <input type="password" name="register_password" id="register_password" placeholder="密码"/>
                    </div>
                    <div class="form-input register_again_password">
                        <span class="fa fa-key" aria-hidden="true"></span>
                        <input type="password" name="register_again_password" id="register_again_password" placeholder="再次确认密码"/>
                    </div>

                    <div class="form-input login_mobile_code" >
                        <span class="fa fa-key" aria-hidden="true"></span>
                        <div style="display: flex;align-items: center;">
                            <input type="text" style="width: 90px;" name="login_mobile_code" id="register_mobile_code" placeholder="验证码"/>
                            <canvas id="canvasCheck" width="120" height="40"></canvas>
                            <span style="padding-left: 5px"><a id="changeImg" >看不清，换一张</a></span>
                        </div>
                    </div>
                    <div class="login-remember d-grid" style="margin-top: .5rem">
                        <label class="check-remaind">
                            <p class="user_mobile_login login-sd">手机号注册</p>
                        </label>
                    </div>
                    <div>
                        <button class="btn theme-button login-btn send_mobile_code_register_btn">发送验证码</button>
                        <button class="btn theme-button login-btn user_register_btn">注册</button>
                    </div>
                </div>
                <p class="signup">已有账号?<a class="signinlink" id="login">登录</a></p>
            </div>

        </div>
    </div>
</section>
<div class="modal fade" id="loginModal" style="display:none;">
    <div class="modal-dialog modal-sm">
        <div class="modal-content" style="border:none;">
            <div class="col-left"></div>
            <div class="col-right">
                <div class="modal-header">
                    <button type="button" id="login_close" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="loginModalLabel" style="font-size: 18px;">我是人</h4>
                </div>
                <div class="modal-body">
                    <section class="box-login v5-input-txt" id="box-login" style="display: flex;justify-content: center">
                        <div id="imgVer" style="display:inline-block;"></div>
                    </section>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script src="../static/js/jquery-3.5.1.min.js"></script>
<script src="../static/js/img_ver.js"></script>
<script src="../static/js/modal.js"></script>
<!--<script src="https://cdn.bootcss.com/crypto-js/3.1.9-1/crypto-js.min.js"></script>-->

<script>
    let zq={
        checkRightCode:"",
        loginType:0,//0表示用户名密码登录，1表示手机号登录
    }
    $(function () {
        init();
    })
    function getCookie(cname){
        let name = cname + "=";
        let ca = document.cookie.split(';');
        for(let i=0; i<ca.length; i++)
        {
            let c = ca[i].trim();
            if (c.indexOf(name)==0) return c.substring(name.length,c.length);
        }
        return "";
    }

    function init(){
        if(getCookie("ZQ_USER_NAME")!=""){
            $(".check-remaind").find("input").prop("checked","checked");
            $("#login_username").val(getCookie("ZQ_USER_NAME"))
        }
        initLogin();

    }

    function initLogin() {
        $("#login_username").focus(function () {
            $("#login_username_tips").css("visibility", "visible");
        }).blur(function () {
            $("#login_username_tips").css("visibility", "collapse");
        })
        imgVer({
            el: '$("#imgVer")',
            width: '260',
            height: '116',
            img: [
                '/static/images/ver.png',
                '/static/images/ver-1.png',
                '/static/images/ver-2.png',
                '/static/images/ver-3.png'
            ],
            success: function () {
                //alert('执行登录函数');
                $.ajax({
                    url:"/hoppinzq?method=login",
                    data:JSON.stringify({
                        "user":{
                            "username":$("#login_username").val(),
                            "password":$("#login_password").val(),
                            "isRemember":$(".check-remaind").find("input").is(":checked")?1:0
                        }
                    }),
                    dataType:"json",
                    type:"post",
                    success:function (data) {
                        console.log(data)
                        if(data.code==200){
                            //let zq_token=getCookie("ZQ_TOKEN");
                            alert("登陆成功，有效时长7天");
                            let query = window.location.search.substring(1);
                            if(query=="")return;
                            let reUrl=query.split("redirect=")[1];
                            if(reUrl.indexOf("ucode=")!=-1){
                                let gqCodeUrl=reUrl.split("ucode=")[1];
                                if(gqCodeUrl.indexOf("?")==-1){
                                    gqCodeUrl=data.data.ucode;
                                }else{
                                    gqCodeUrl=data.data.ucode+gqCodeUrl.split("&")[1]
                                }
                                reUrl=reUrl.split("ucode=")[0]+"ucode="+gqCodeUrl;
                            }else{
                                if(reUrl.indexOf("?")==-1){
                                    reUrl+="?ucode="+data.data.ucode;
                                }else{
                                    reUrl+="&ucode="+data.data.ucode;
                                }
                            }

                            // if(reUrl.indexOf(window.location.host)==-1){
                            //     $("body").append($("<iframe style='display: none' src='"+ip+"/cookie.html?cookie='"+zq_token+"&redirect="+reUrl+"></iframe>"));
                            // }else{
                            //     window.location.href=reUrl;
                            // }
                            window.location.href=reUrl;
                        }else{
                            alert("登陆失败:"+JSON.stringify(data));
                            $("#login_close").click();
                        }
                    }
                })
            },
            error: function () {
                //alert('错误什么都不执行')
            }
        });

        $(".login-btn").on("click", function () {
            if($("#login_username").val().length==0){
                alert("请填写用户名");
                $("#login_username").focus();
                return;
            }
            if($("#login_password").val().length==0){
                alert("请填写密码");
                $("#login_password").focus();
                return;
            }
            $("#loginModal").modal("show");
        }),function() {
            let e = [];
            $(".modal").on("show.bs.modal",
                function() {
                    for (let s = 0; e.length > s; s++) e[s] && (e[s].modal("hide"), e[s] = null);
                    e.push($(this));
                    let o = $(this),
                        a = o.find(".modal-dialog"),
                        t = $('<div style="display:table; width:100%; height:100%;"></div>');
                    t.html('<div style="vertical-align:middle; display:table-cell;"></div>'),
                        t.children("div").html(a),
                        o.html(t)
                })
        }();

        $(".user_mobile_login").click(function () {
            $(".login_username").slideUp(500);
            $(".login_password").slideUp(500);
            $(".user_login_btn").slideUp(500);
            $(".remember_username_login").css("visibility", "collapse");
            $(this).slideUp(500,function () {
                $(".user_username_login").slideDown(500);
                $(".login_mobile").slideDown(500).css("display","grid");
                $(".login_mobile_code").slideDown(500).css("display","grid");
                $(".send_mobile_code_login_btn").slideDown(500);
            })
        });
        $(".user_username_login").click(function () {
            $(".login_mobile").slideUp(500);
            $(".login_mobile_code").slideUp(500);
            $(".send_mobile_code_login_btn").slideUp(500);
            $(this).slideUp(500,function () {
                $(".remember_username_login").css("visibility", "visible");
                $(".user_mobile_login").slideDown(500)
                $(".login_username").slideDown(500);
                $(".login_password").slideDown(500);
                $(".user_login_btn").slideDown(500);
            })
        });
        $("#register").click(function () {
            $("#login_page").fadeOut(500,function () {
                $("#register_page").fadeIn(500);
                initRegister();
                $("#register_page").find("input").each(function (index,element){
                    $(element).val("");
                })
            })
            $("#login").on("click",function () {
                $("#register_page").fadeOut(500,function () {
                    $("#login_page").fadeIn(500);
                    $("#login_page").find("input").each(function (index,element){
                        $(element).val("");
                    })
                    initLogin();
                })
            })
        })
    }

    function initRegister() {
        drawPic();
        $(".send_mobile_code_register_btn").click(function () {
            let register_username=$("#register_username").val().trim();
            let emailStr=$("#register_email").val().trim();
            let emailReg = /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(\.[a-zA-Z0-9_-])+/;
            if(register_username.length==0){
                alert("请填写用户名")
                $("#register_email").focus();
                return;
            }
            if(emailStr.length==0){
                alert("请填写邮箱")
                $("#register_email").focus();
                return;
            }
            if(emailStr.lastIndexOf("163.com")==-1){
                alert("现在只支持163邮箱")
                $("#register_email").focus();
                return;
            }
            if (!emailReg.test(emailStr) ) {
                alert("邮箱格式不正确")
                $("#register_email").focus();
                return;
            }
            imgVer({
                el: '$("#imgVer")',
                width: '260',
                height: '116',
                img: [
                    '/static/images/ver.png',
                    '/static/images/ver-1.png',
                    '/static/images/ver-2.png',
                    '/static/images/ver-3.png'
                ],
                success: function () {
                    $.ajax({
                        url:"/hoppinzq?method=registerEmail",
                        data:JSON.stringify({
                            "user":{
                                "username":register_username,
                                "email":emailStr,
                                "code":$("#register_email_code").val()
                            }
                        }),
                        dataType:"json",
                        type:"post",
                        success:function (data) {
                            console.log(data);
                            if(data.code==200){
                                alert("请注意邮箱");
                            }
                        }
                    })
                },
                error: function () {
                    //alert('错误什么都不执行')
                }
            });
        })
    }

    //生成一个随机数
    function randomNum(min,max){
        return Math.floor( Math.random()*(max-min)+min);
    }
    //生成一个随机色
    function randomColor(min,max){
        let r = randomNum(min,max);
        let g = randomNum(min,max);
        let b = randomNum(min,max);
        return "rgb("+r+","+g+","+b+")";
    }

    document.getElementById("changeImg").onclick = function(e){
        e.preventDefault();
        drawPic();
    }

    function drawPic(){
        let canvas=document.getElementById("canvasCheck");
        let width=canvas.width;
        let height=canvas.height;
        let ctx = canvas.getContext('2d');
        ctx.textBaseline = 'bottom';

        //绘制背景色
        ctx.fillStyle = randomColor(180,240);
        ctx.fillRect(0,0,width,height);
        //绘制文字
        checkRightCode="";
        let str = 'ABCEFGHJKLMNPQRSTWXY13456789';
        for(let i=0; i<4; i++){
            let txt = str[randomNum(0,str.length)];
            checkRightCode+=txt;
            ctx.fillStyle = randomColor(50,160);  //随机生成字体颜色
            ctx.font = randomNum(25,40)+'px SimHei'; //随机生成字体大小
            let x = 10+i*25;
            let y = randomNum(25,45);
            let deg = randomNum(-45, 45);
            //修改坐标原点和旋转角度
            ctx.translate(x,y);
            ctx.rotate(deg*Math.PI/180);
            ctx.fillText(txt, 0,0);
            //恢复坐标原点和旋转角度
            ctx.rotate(-deg*Math.PI/180);
            ctx.translate(-x,-y);
        }
        //绘制干扰线
        for(let i=0; i<5; i++){
            ctx.strokeStyle = randomColor(40,180);
            ctx.beginPath();
            ctx.moveTo( randomNum(0,width), randomNum(0,height) );
            ctx.lineTo( randomNum(0,width), randomNum(0,height) );
            ctx.stroke();
        }
        //绘制干扰点
        for(let i=0; i<50; i++){
            ctx.fillStyle = randomColor(0,255);
            ctx.beginPath();
            ctx.arc(randomNum(0,width),randomNum(0,height), 1, 0, 2*Math.PI);
            ctx.fill();
        }
    }

</script>
</html>